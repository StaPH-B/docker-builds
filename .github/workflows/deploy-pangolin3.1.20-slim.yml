# This caller workflow tests, builds, and pushes the image to Docker Hub.
# It also tests that a Singularity container can be run from the Docker image.

name: Deploy Pangolin 3.1.20-pangolearn-2022-02-28-slim image

on: workflow_dispatch

jobs:

  build-to-test:
    uses: ./.github/workflows/build-to-test.yml
    with:
      path_to_context: "./pangolin/3.1.20-slim/"
      dockerfile_name: "Dockerfile"
      cache: "pangolin"

  build-to-deploy:
    needs: build-to-test  # this jobs needs to run serially, after testing succeeds
    uses: ./.github/workflows/build-to-deploy.yml
    secrets:
      docker_username: ${{ secrets.DOCKER_HUB_USERNAME }}
      docker_access_token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      quay_username: ${{ secrets.quay_username }}
      quay_robot_token: ${{ secrets.quay_robot_token }}
    with:
      path_to_context: "./pangolin/3.1.20-slim/"
      dockerfile_name: "Dockerfile"
      cache: "pangolin"
      container_name: "pangolin"
      tag: "3.1.20-pangolearn-2022-02-28" # only specifying one tag since build-to-deploy assumes pushing "latest" tag

  run-singularity:
    needs: build-to-deploy  # test singularity run on newly pushed Docker image
    uses: ./.github/workflows/run-singularity.yml
    with:
      image_name: "pangolin:3.1.20-pangolearn-2022-02-28"
