name: Deploy htslib image

on: workflow_dispatch

env:
  tool: "htslib"
  version: "1.15"

jobs:
  params:
    runs-on: ubuntu-latest
    outputs:
      params: ${{ steps.env-vars.outputs.params }}
    steps:
      - id: env-vars
        run: echo "::set-output name=params::$(echo $(jq -n 'env'))"

  build-to-test:
    uses: StaPH-B/docker-builds/.github/workflows/build-to-test.yml@master
    with:
      tool: "${{ fromJson(needs.params.outputs.params).tool }}"
      version: "${{ fromJson(needs.params.outputs.params).version }}"

  build-to-deploy:
    needs: build-to-test  # this jobs needs to run serially, after testing succeeds
    uses: StaPH-B/docker-builds/.github/workflows/build-to-deploy.yml@master
    with:
      tool: "${{ fromJson(needs.params.outputs.params).tool }}"
      version: "${{ fromJson(needs.params.outputs.params).version }}"

  run-singularity:
    needs: build-to-deploy  # test singularity run on newly pushed Docker image
    uses: StaPH-B/docker-builds/.github/workflows/run-singularity.yml@master
    with:
      image_name: "${{ fromJson(needs.params.outputs.params).tool }}:${{ fromJson(needs.params.outputs.params).version }}"
