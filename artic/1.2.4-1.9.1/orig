ARG ARTIC_VER=1.2.4
#ARG SAMTOOLS_VER=1.17
#ARG PORECHOP_VER=0.2.4
#ARG MINIMAP2_VER=2.25
#ARG LONGSHOT_VER=0.4.5

#FROM staphb/samtools:${SAMTOOLS_VER} AS samtools
#FROM staphb/bcftools:${SAMTOOLS_VER} AS bcftools
#FROM staphb/htslib:${SAMTOOLS_VER}   AS htslib
#FROM staphb/porechop:${PORECHOP_VER} AS porechop
#FROM staphb/minimap2:${MINIMAP2_VER} AS minimap2

FROM mambaorg/micromamba:1.4.9 as mamba

#ARG LONGSHOT_VERSION

USER root
WORKDIR /

RUN micromamba install --name base -c conda-forge -c bioconda -c defaults longshot=${LONGSHOT_VER}

FROM ubuntu:jammy as app

# WARNING : On 2023-09-01, medaka's README had this quote : "The bioconda releases lag behind the source code and PyPI releases."
# Also, the bioconda version of artic also seemed to lag the github release
ARG ARTIC_VER
ARG MINIMAP2_VER
ARG MEDAKA_VER=1.9.1

LABEL base.image="ubuntu:jammy"
LABEL dockerfile.version="1"
LABEL software="artic"
LABEL software.version="${ARTIC_VER}"
LABEL software1="medaka"
LABEL software1.version="${MEDAKA_VER}"
LABEL description="A bioinformatics pipeline for working with virus sequencing data sequenced with nanopore"
LABEL website="https://github.com/artic-network/fieldbioinformatics"
LABEL license="https://github.com/artic-network/fieldbioinformatics/blob/master/LICENSE"
LABEL sop="https://artic.network/ncov-2019/ncov2019-bioinformatics-sop.html"
LABEL maintainer="Erin Young"
LABEL maintainer.email="eriny@utah.gov"

# Example apt-get command for commonly-missing dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    ca-certificates \
    procps \
    gcc \
    libcurl3-gnutls \
    libssl-dev \
    python3-dev \
    python3-pip \
    python-is-python3 && \
    apt-get autoclean && rm -rf /var/lib/apt/lists/*

# "installing" samtools, bgzip, porechop, longshot, and minimap2
COPY --from=samtools /usr/local/bin/*                      /usr/local/bin/
COPY --from=bcftools /usr/local/bin/*                      /usr/local/bin/
COPY --from=htslib   /usr/local/bin/*                      /usr/local/bin/
COPY --from=porechop /usr/local/bin/*                      /usr/local/bin/
COPY --from=mamba    /opt/conda/bin/*                      /usr/local/bin/
COPY --from=minimap2 /minimap2-${MINIMAP2_VER}_x64-linux/* /usr/local/bin/

# install medaka with pip
RUN pip install --upgrade pip setuptools==57.5.0 && \
    pip install biopython clint pandas pysam pytest pyvcf requests tqdm medaka==${MEDAKA_VER} && \
    medaka --version

# install artic make /data to use as a working directory
RUN wget -q https://github.com/artic-network/fieldbioinformatics/archive/refs/tags/v${ARTIC_VER}.tar.gz && \
    tar -xzf v${ARTIC_VER}.tar.gz && \
    ls / && \
    rm v${ARTIC_VER}.tar.gz && \
    cd fieldbioinformatics-${ARTIC_VER} && \
    python setup.py install && \
    artic -v && \
    mkdir /data

# 'ENV' instructions set environment variables that persist from the build into the resulting image
# set the environment, add base conda/micromamba bin directory into path
# set locale settings to UTF-8
ENV PATH="/opt/conda/bin/:${PATH}" \
    LC_ALL=C.UTF-8

# 'CMD' instructions set a default command when the container is run. This is typically 'tool --help.'
CMD artic --help

# set final working directory to /data
WORKDIR /data

##### ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- #####
##### Step 2. Set up the testing stage.                                 #####
##### The docker image is built to the 'test' stage before merging, but #####
##### the test stage (or any stage after 'app') will be lost.           #####
##### ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- #####

# A second FROM insruction creates a new stage
# new base for testing
FROM app as test
ARG ARTIC_VER

# print help and version info; check dependencies (not all software has these options available)
# Mostly this ensures the tool of choice is in path and is executable
RUN artic --help && \
    artic --version

# set working directory so that all test inputs & outputs are kept in /test
WORKDIR /fieldbioinformatics-${ARTIC_VER}

# test that came with artic
RUN bash ./test-runner.sh medaka

# using on "real" data (sample files were not sequenced with version 5.3.2 primers)
RUN wget -q ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR224/050/SRR22452250/SRR22452250_1.fastq.gz && \
    artic guppyplex --min-length 400 --max-length 700  --directory . --prefix SRR22452250_1.fastq.gz --output SRR22452250_1_filtered.fastq.gz && \
    mkdir -p directory/nCoV-2019/v5.3.2 && \
    wget https://raw.githubusercontent.com/artic-network/primer-schemes/master/nCoV-2019/V5.3.2/SARS-CoV-2.primer.bed      --directory-prefix directory/nCoV-2019/v5.3.2 && \
    wget https://raw.githubusercontent.com/artic-network/primer-schemes/master/nCoV-2019/V5.3.2/SARS-CoV-2.reference.fasta --directory-prefix directory/nCoV-2019/v5.3.2 && \
    wget https://raw.githubusercontent.com/artic-network/primer-schemes/master/nCoV-2019/V5.3.2/SARS-CoV-2.scheme.bed      --directory-prefix directory/nCoV-2019/v5.3.2 && \
    samtools faidx directory/nCoV-2019/v5.3.2/SARS-CoV-2.reference.fasta && \
    artic minion --normalise 200 --skip-nanopolish --medaka --medaka-model r941_min_high_g360 --threads 4 --read-file input.fastq.gz --scheme-directory directory --scheme-version 5.3.2 nCoV-2019 final && \
    ls final*

